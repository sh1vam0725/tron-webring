name: Validate Member PR

on:
  pull_request:
    branches:
      - main
    paths:
      - 'members.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Members Data

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for non-members.json changes
        run: |
          git fetch origin main
          OTHER_FILES=$(git diff origin/main HEAD --name-only | grep -v '^members\.json$' | wc -l)
          if [ "$OTHER_FILES" -gt 0 ]; then
            echo "‚ùå Error: This PR modifies files other than members.json."
            echo "Non-member contributions require manual review by the maintainer ‚Äî no automation allowed."
            exit 1
          fi
          echo "‚úÖ Only members.json was changed"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Make validation script executable
        run: chmod +x scripts/validate-members.js

      - name: Run validation
        run: node scripts/validate-members.js

      - name: Check for single member addition (exactly 3 field lines)
        run: |
          git fetch origin main
          DIFF_FIELDS=$(git diff origin/main HEAD -- members.json | grep -E '^\+[[:space:]]+"[^"]+":')
          ADDED_FIELDS=$(echo "$DIFF_FIELDS" | grep -c '.' || true)
          echo "Number of new field lines: $ADDED_FIELDS"
          if [ "$ADDED_FIELDS" -ne 3 ]; then
            echo "‚ùå Error: Exactly 3 lines must be added to members.json (name, grad_year, url). Found: $ADDED_FIELDS"
            exit 1
          fi
          UNEXPECTED_FIELDS=$(echo "$DIFF_FIELDS" | grep -cvE '^\+[[:space:]]+"(name|grad_year|url)":' || true)
          if [ "$UNEXPECTED_FIELDS" -gt 0 ]; then
            echo "‚ùå Error: Only the fields name, grad_year, and url are allowed in a member entry"
            exit 1
          fi
          echo "‚úÖ Exactly 3 required field lines detected (name, grad_year, url)"

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Validation Passed!**\n\nYour member data looks good! A maintainer will review and merge your PR soon.\n\nThank you for joining the webring! üéâ'
            })

      - name: Comment on PR failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Validation Failed**\n\nPlease check the validation errors above and update your PR accordingly.\n\nMake sure to:\n- Only modify `members.json` (other file changes require manual review)\n- Add exactly ONE member with exactly 3 fields: `name`, `grad_year`, `url`\n- Use a valid URL format (starting with http:// or https://)\n- Use a `grad_year` of 2003 or later\n\nIf you need help, feel free to ask in the PR comments!'
            })
